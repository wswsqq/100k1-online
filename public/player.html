<!doctype html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="/style.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100 –∫ 1 ‚Äî –ò–≥—Ä–æ–∫</title>

  <style>
    .wrap { max-width: 780px; margin: 0 auto; padding: 20px; }
    h1,h2 { margin-top: 0; }
    .card { background:#111a2e; border-radius:14px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { opacity:.8; }
    .badge { display:inline-block; padding:4px 10px; border:1px solid #1f2a44; border-radius:999px; }

    button { padding:10px 14px; border-radius:10px; border:none; background:#22c55e; color:#fff; font-size:16px; cursor:pointer; }
    button.secondary { background:#475569; }
    button:disabled { opacity:.4; cursor:not-allowed; }

    input[type="text"]{
      width:100%;
      box-sizing:border-box;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #1f2a44;
      background:#0b1328;
      color:#fff;
      font-size:16px;
      outline:none;
    }

    table { width:100%; border-collapse:collapse; }
    th,td { padding:8px; border-bottom:1px solid #1f2a44; text-align:left; }
    .hidden { display:none; }

    /* ===== Winner Animation ===== */
    .winner-hero{ text-align:center; padding:18px 12px; }
    .cup{
      font-size:76px; line-height:1; display:inline-block;
      filter: drop-shadow(0 12px 28px rgba(0,0,0,.55));
      transform: translateY(10px) scale(.9);
      opacity:0;
    }
    .winner-title{ margin:10px 0 0; font-size:30px; font-weight:800; opacity:0; transform: translateY(8px); }
    .winner-name{ margin:6px 0 0; font-size:22px; opacity:0; transform: translateY(8px); }
    .winner-score{ margin:8px 0 0; font-size:18px; opacity:0; transform: translateY(8px); }

    #winnerScreen.pop .cup{ animation: popIn .7s cubic-bezier(.2,.9,.2,1) forwards; }
    #winnerScreen.pop .winner-title{ animation: slideUp .6s .12s cubic-bezier(.2,.9,.2,1) forwards; }
    #winnerScreen.pop .winner-name{ animation: slideUp .6s .22s cubic-bezier(.2,.9,.2,1) forwards; }
    #winnerScreen.pop .winner-score{ animation: slideUp .6s .32s cubic-bezier(.2,.9,.2,1) forwards; }

    .podium { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .podium .p { flex:1; min-width:220px; border:1px solid #1f2a44; border-radius:12px; padding:12px; }
    .big { font-size:22px; font-weight:700; }

    #winnerScreen.pop .podium .p{ animation: rise .5s .25s ease-out both; }
    #winnerScreen.pop .podium .p:nth-child(2){ animation-delay:.33s; }
    #winnerScreen.pop .podium .p:nth-child(3){ animation-delay:.41s; }

    @keyframes popIn { to{ opacity:1; transform: translateY(0) scale(1);} }
    @keyframes slideUp { to{ opacity:1; transform: translateY(0);} }
    @keyframes rise { from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform: translateY(0);} }

    /* ===== Confetti canvas ===== */
    #confetti{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
      display:none;
    }

    /* ===== Violet buttons (Player) ===== */
    button.violet {
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      color: #fff;
      box-shadow: 0 6px 18px rgba(139, 92, 246, 0.35);
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    button.violet:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      animation: pulseViolet 1.2s infinite;
    }
    button.violet:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.35); }
    button.violet:disabled { opacity: .45; box-shadow: none; animation: none; cursor: not-allowed; }
    @keyframes pulseViolet {
      0%   { box-shadow: 0 0 0 0 rgba(139,92,246,.55); }
      70%  { box-shadow: 0 0 0 14px rgba(139,92,246,0); }
      100% { box-shadow: 0 0 0 0 rgba(139,92,246,0); }
    }

    /* =========================================================
       ===== VolumeBox (–∫–∞–∫ –≤ host: 1-–≤-1) =====
       ========================================================= */
    #volumeBox{
      position: fixed;
      top: 16px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: rgba(17, 26, 46, 0.92);
      border-radius: 14px;
      border: 1px solid #1f2a44;
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    #volumeBox .vol-icon{ font-size: 20px; }

    #volumeBox input[type="range"]{
      width: 180px;
      height: 6px;
      cursor: pointer;
    }

    #volumeBox #volLabel{
      min-width: 52px;
      text-align: right;
      font-weight: 700;
      font-size: 16px;
      opacity: .95;
    }

    /* —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–∫–∏ (–Ω–µ –ø—Ä—ã–≥–∞–µ—Ç) */
    #volumeBox button.mute-btn{
      width: 56px;
      height: 40px;
      padding: 0;

      display: inline-flex;
      align-items: center;
      justify-content: center;

      font-size: 18px;
      line-height: 1;

      border-radius: 12px;
      border: 1px solid #1f2a44;

      cursor: pointer;
      user-select: none;

      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease, background .15s ease;
    }

    /* ON (–∑–≤—É–∫ –≤–∫–ª—é—á—ë–Ω) */
    #volumeBox button.mute-btn.is-on{
      background: linear-gradient(135deg, #8b5cf6, #6d28d9) !important;
      color:#fff;
      box-shadow: 0 10px 22px rgba(139, 92, 246, 0.35);
    }

    /* OFF (–∑–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω) */
    #volumeBox button.mute-btn.is-off{
      background: #475569 !important;
      color:#fff;
      box-shadow: none;
    }

    /* hover glow (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π) */
    #volumeBox button.mute-btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.05);
      animation: pulseVioletGlow 1.2s infinite;
    }
    #volumeBox button.mute-btn:active{ transform: translateY(0); }

    /* –¥–∞–∂–µ –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ —Å–ª—É—á–∞–π–Ω–æ disabled ‚Äî –ù–ï –ª–æ–º–∞–µ–º */
    #volumeBox button.mute-btn:disabled{
      opacity: 1 !important;
      cursor: pointer !important;
    }

    @keyframes pulseVioletGlow{
      0%   { box-shadow: 0 0 0 0 rgba(139,92,246,.55); }
      70%  { box-shadow: 0 0 0 14px rgba(139,92,246,0); }
      100% { box-shadow: 0 0 0 0 rgba(139,92,246,0); }
    }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>

  <!-- üîä Volume control -->
  <div id="volumeBox">
    <span class="vol-icon" id="volIcon">üîä</span>
    <input id="vol" type="range" min="0" max="100" value="80">
    <span id="volLabel">80%</span>
    <button id="muteBtn" class="mute-btn is-on" type="button" aria-label="Mute">üîä</button>
  </div>

  <div class="wrap">
    <h1>–ò–≥—Ä–æ–∫</h1>

    <!-- –í–•–û–î -->
    <div class="card" id="joinCard">
      <div class="muted" style="margin-bottom:10px;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∏–≥—Ä—É</div>
      <input id="name" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="24" />
      <div class="row" style="margin-top:10px;">
        <button id="joinBtn">–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
        <span class="badge" id="roomBadge">–ö–æ–º–Ω–∞—Ç–∞: ‚Äî</span>
        <span class="badge" id="statusBadge">–ù–µ –≤ –∏–≥—Ä–µ</span>
      </div>
    </div>

    <!-- –ò–ì–†–ê -->
    <div id="gameScreen" class="hidden">
      <div class="card">
        <div class="row">
          <span class="badge" id="qBadge">–í–æ–ø—Ä–æ—Å: ‚Äî</span>
          <span class="badge" id="timer">‚è± 0</span>
        </div>
        <h2 style="margin-top:10px;">–í–æ–ø—Ä–æ—Å</h2>
        <div id="questionText">‚Äî</div>
      </div>

      <div class="card">
        <h2>–í–∞—à –æ—Ç–≤–µ—Ç</h2>
        <input id="answer" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–ø—Ä–∞–≤–∏—Ç—å" maxlength="60" />
        <div class="row" style="margin-top:10px;">
          <button id="sendBtn" class="violet">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button id="clearBtn" class="secondary" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <span class="muted" id="sendHint">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h2>–¢–∞–±–ª–∏—Ü–∞</h2>
        <table>
          <thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–û—á–∫–∏</th></tr></thead>
          <tbody id="players"></tbody>
        </table>
      </div>
    </div>

    <!-- üèÜ –≠–ö–†–ê–ù –ü–û–ë–ï–î–ò–¢–ï–õ–Ø -->
    <div id="winnerScreen" class="hidden">
      <div class="card">
        <div class="winner-hero">
          <div class="cup">üèÜ</div>
          <div class="winner-title">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
          <div class="winner-name" id="winnerName">‚Äî</div>
          <div class="winner-score" id="winnerScore">–û—á–∫–∏: 0</div>
        </div>

        <div class="podium" id="podium"></div>

        <div class="muted" style="margin-top:10px;">
          –ñ–¥–∏—Ç–µ: –≤–µ–¥—É—â–∏–π –Ω–∞–∂–º—ë—Ç ¬´–ù–æ–≤–∞—è –∏–≥—Ä–∞¬ª, –∏ –Ω–∞—á–Ω—ë—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –æ–ø—Ä–æ—Å.
        </div>
      </div>

      <div class="card">
        <h2>–ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
        <table>
          <thead><tr><th>–ú–µ—Å—Ç–æ</th><th>–ò–º—è</th><th>–û—á–∫–∏</th></tr></thead>
          <tbody id="finalTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // UI
    const joinCard = document.getElementById("joinCard");
    const joinBtn = document.getElementById("joinBtn");
    const nameEl = document.getElementById("name");
    const roomBadge = document.getElementById("roomBadge");
    const statusBadge = document.getElementById("statusBadge");

    const gameScreen = document.getElementById("gameScreen");
    const winnerScreen = document.getElementById("winnerScreen");

    const qBadge = document.getElementById("qBadge");
    const timerEl = document.getElementById("timer");
    const questionText = document.getElementById("questionText");

    const answerEl = document.getElementById("answer");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const sendHint = document.getElementById("sendHint");

    const playersEl = document.getElementById("players");

    const podiumEl = document.getElementById("podium");
    const finalTableEl = document.getElementById("finalTable");
    const winnerNameEl = document.getElementById("winnerName");
    const winnerScoreEl = document.getElementById("winnerScore");

    // URL code
    const params = new URLSearchParams(location.search);
    const roomCode = (params.get("code") || "").toUpperCase();
    roomBadge.textContent = roomCode ? `–ö–æ–º–Ω–∞—Ç–∞: ${roomCode}` : "–ö–æ–º–Ω–∞—Ç–∞: ‚Äî";

    // sounds
    const winAudio = new Audio("/sounds/win.mp3");
    winAudio.preload = "auto";
    const drumAudio = new Audio("/sounds/drum.mp3");
    drumAudio.preload = "auto";

    // ===== Volume logic (–∫–∞–∫ –≤ host: 1-–≤-1) =====
    const volEl = document.getElementById("vol");
    const volLabel = document.getElementById("volLabel");
    const muteBtn = document.getElementById("muteBtn");
    const volIcon = document.getElementById("volIcon");

    let muted = false;

    function applyVolumeUI(){
      const v = Number(volEl.value);     // 0..100
      volLabel.textContent = `${v}%`;

      const vol01 = v / 100;             // 0..1
      winAudio.volume = vol01;
      drumAudio.volume = vol01;

      winAudio.muted = muted;
      drumAudio.muted = muted;

      const icon = muted ? "üîá" : "üîä";
      muteBtn.textContent = icon;
      volIcon.textContent = icon;

      muteBtn.classList.toggle("is-on", !muted);
      muteBtn.classList.toggle("is-off", muted);

      muteBtn.disabled = false; // –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞
    }

    applyVolumeUI();

    volEl.addEventListener("input", () => {
      muted = false;
      applyVolumeUI();
    });

    muteBtn.addEventListener("click", () => {
      muted = !muted;
      applyVolumeUI();
    });

    // —á—Ç–æ–±—ã —Ñ–∏–Ω–∞–ª –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–ª—Å—è
    let finishHandledFor = null;

    let joined = false;
    let answeredThisQuestion = false;

    // üéâ confetti
    const confettiCanvas = document.getElementById("confetti");
    const ctx = confettiCanvas.getContext("2d");

    function resizeConfetti(){
      confettiCanvas.width = window.innerWidth * devicePixelRatio;
      confettiCanvas.height = window.innerHeight * devicePixelRatio;
      confettiCanvas.style.width = window.innerWidth + "px";
      confettiCanvas.style.height = window.innerHeight + "px";
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener("resize", resizeConfetti);

    function startConfetti(durationMs = 3000){
      resizeConfetti();
      confettiCanvas.style.display = "block";

      const W = window.innerWidth;
      const H = window.innerHeight;
      const particles = [];
      const count = 180;

      for (let i=0;i<count;i++){
        particles.push({
          x: Math.random()*W,
          y: -20 - Math.random()*H*0.3,
          vx: (Math.random()*2-1) * 2.2,
          vy: 3 + Math.random()*4.5,
          size: 4 + Math.random()*6,
          rot: Math.random()*Math.PI,
          vr: (Math.random()*2-1)*0.2,
          hue: Math.floor(Math.random()*360),
          life: 0
        });
      }

      const t0 = performance.now();

      function frame(t){
        const dt = (t - t0);
        ctx.clearRect(0,0,W,H);

        for (const p of particles){
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.vy += 0.02;
          p.vx *= 0.995;
          p.life += 1;

          const sway = Math.sin(p.life*0.1) * 0.6;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = `hsl(${p.hue} 90% 60%)`;
          ctx.fillRect(-p.size/2 + sway, -p.size/2, p.size, p.size);
          ctx.restore();

          if (p.y > H + 30){
            p.y = -20;
            p.x = Math.random()*W;
            p.vy = 3 + Math.random()*4.5;
          }
        }

        if (dt < durationMs){
          requestAnimationFrame(frame);
        } else {
          confettiCanvas.style.display = "none";
          ctx.clearRect(0,0,W,H);
        }
      }

      requestAnimationFrame(frame);
    }

    // –ø—Ä–æ–≥—Ä–µ–≤–∞–µ–º –∞—É–¥–∏–æ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º (—á—Ç–æ–±—ã Chrome –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª)
    document.addEventListener("click", () => {
      drumAudio.play().then(() => { drumAudio.pause(); drumAudio.currentTime = 0; }).catch(()=>{});
      winAudio.play().then(() => { winAudio.pause(); winAudio.currentTime = 0; }).catch(()=>{});
    }, { once:true });

    function showGame(){
      winnerScreen.classList.add("hidden");
      gameScreen.classList.remove("hidden");
    }
    function showWinner(){
      gameScreen.classList.add("hidden");
      winnerScreen.classList.remove("hidden");

      winnerScreen.classList.remove("pop");
      void winnerScreen.offsetWidth;
      winnerScreen.classList.add("pop");
    }

    function setJoinedUI(){
      joinBtn.disabled = true;
      joinBtn.textContent = "–í—ã –≤ –∏–≥—Ä–µ ‚úÖ";
      joinBtn.style.background = "#475569";
      statusBadge.textContent = "–í—ã –≤ –∏–≥—Ä–µ ‚úÖ";
      joined = true;

      joinCard.classList.add("hidden");
      showGame();
    }

    joinBtn.onclick = () => {
      const name = (nameEl.value || "").trim();
      if (!roomCode) return alert("–ù–µ—Ç –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã –≤ —Å—Å—ã–ª–∫–µ!");
      socket.emit("player:join", { code: roomCode, name });
      setJoinedUI();
    };

    clearBtn.onclick = () => { answerEl.value = ""; };

    sendBtn.onclick = () => {
      if (!joined) return;
      if (answeredThisQuestion) return;

      const text = (answerEl.value || "").trim();
      if (!text) return;

      socket.emit("player:answer", { code: roomCode, text });
      answeredThisQuestion = true;
      sendBtn.disabled = true;
      sendHint.textContent = "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ";
    };

    answerEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    socket.on("error:msg", (msg) => alert(msg));

    function runFinishSequence(state) {
      if (finishHandledFor === roomCode) {
        showWinner();
        return;
      }
      finishHandledFor = roomCode;

      const afterDrum = () => {
        const players = state.players || [];
        const top = players[0];

        winnerNameEl.textContent = top ? `ü•á ${top.name}` : "‚Äî";
        winnerScoreEl.textContent = `–û—á–∫–∏: ${top ? top.score : 0}`;

        const top3 = players.slice(0,3);
        const medals = ["ü•á","ü•à","ü•â"];
        podiumEl.innerHTML = "";
        for (let i=0;i<3;i++){
          const p = top3[i];
          const name = p ? p.name : "‚Äî";
          const score = p ? p.score : 0;

          const div = document.createElement("div");
          div.className = "p";
          div.innerHTML = `
            <div class="big">${medals[i]} ${i+1} –º–µ—Å—Ç–æ</div>
            <div style="margin-top:6px;">–ò–≥—Ä–æ–∫: <b>${name}</b></div>
            <div style="margin-top:4px;">–û—á–∫–∏: <b>${score}</b></div>
          `;
          podiumEl.appendChild(div);
        }

        finalTableEl.innerHTML = "";
        players.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${idx+1}</td><td>${p.name}</td><td>${p.score}</td>`;
          finalTableEl.appendChild(tr);
        });

        showWinner();

        try { winAudio.currentTime = 0; winAudio.play().catch(()=>{}); } catch(e){}
        startConfetti(3000);
      };

      const onEnd = () => afterDrum();
      drumAudio.addEventListener("ended", onEnd, { once: true });

      const durMs =
        Number.isFinite(drumAudio.duration) && drumAudio.duration > 0
          ? Math.ceil(drumAudio.duration * 1000)
          : 1400;

      const fallbackTimer = setTimeout(() => {
        drumAudio.removeEventListener("ended", onEnd);
        afterDrum();
      }, durMs + 200);

      try {
        drumAudio.currentTime = 0;
        const p = drumAudio.play();
        if (p && typeof p.then === "function") {
          p.catch(() => {
            clearTimeout(fallbackTimer);
            drumAudio.removeEventListener("ended", onEnd);
            afterDrum();
          });
        }
      } catch (e) {
        clearTimeout(fallbackTimer);
        drumAudio.removeEventListener("ended", onEnd);
        afterDrum();
      }
    }

    socket.on("room:update", (state) => {
      if (!state) return;

      timerEl.textContent = `‚è± ${state.timeLeft ?? 0}`;

      playersEl.innerHTML = "";
      (state.players || []).forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.name}</td><td>${p.score}</td>`;
        playersEl.appendChild(tr);
      });

      if (state.phase === "lobby") {
        finishHandledFor = null;
        showGame();

        qBadge.textContent = "–í–æ–ø—Ä–æ—Å: ‚Äî";
        questionText.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞‚Ä¶";

        answeredThisQuestion = false;
        sendBtn.disabled = false;
        sendHint.textContent = "‚Äî";
        return;
      }

      if (state.phase === "question") {
        showGame();

        qBadge.textContent = `–í–æ–ø—Ä–æ—Å ${state.questionNumber}/${state.totalQuestions}`;
        questionText.textContent = state.question || "‚Äî";

        answeredThisQuestion = false;
        sendBtn.disabled = false;
        sendHint.textContent = "–ü–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–∏–º–∞–π—Ç–µ –û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        return;
      }

      if (state.phase === "results") {
        showGame();
        qBadge.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (${state.questionNumber}/${state.totalQuestions})`;
        questionText.textContent = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É –≤–µ–¥—É—â–µ–≥–æ. –ñ–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å‚Ä¶";
        return;
      }

      if (state.phase === "finished") {
        runFinishSequence(state);
        return;
      }
    });

    nameEl.value = "";

    if (!roomCode) {
      statusBadge.textContent = "–ù–µ—Ç –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã";
      joinBtn.disabled = true;
      joinBtn.textContent = "–ù—É–∂–Ω–∞ —Å—Å—ã–ª–∫–∞ –≤–µ–¥—É—â–µ–≥–æ";
    }
  </script>
</body>
</html>
