<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100 –∫ 1 ‚Äî –ò–≥—Ä–æ–∫</title>

  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif;color:#fff;background:radial-gradient(1200px 800px at 10% 10%, rgba(59,130,246,1), transparent 60%),radial-gradient(1000px 900px at 90% 35%, rgba(168,85,247,1), transparent 65%),radial-gradient(900px 900px at 50% 90%, rgba(217,70,239,0.95), transparent 70%),linear-gradient(180deg,#0b102a,#0b102a);min-height:100vh;}
    .wrap{max-width:780px;margin:0 auto;padding:20px;}
    .titleRow{display:flex;align-items:center;justify-content:center;margin:0 0 14px;}
    h1{margin:0;text-align:center;}
    .card{background:rgba(17,26,46,.92);border-radius:14px;padding:16px;margin-bottom:16px;border:1px solid #1f2a44;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .muted{opacity:.8;}
    .badge{display:inline-block;padding:4px 10px;border:1px solid #1f2a44;border-radius:999px;}
    button{padding:10px 14px;border-radius:10px;border:none;background:#22c55e;color:#fff;font-size:16px;cursor:pointer;}
    button.secondary{background:#475569;}
    button.violet{background:linear-gradient(135deg,#8b5cf6,#6d28d9);}
    button:disabled{opacity:.45;cursor:not-allowed;}
    input[type="text"]{width:100%;box-sizing:border-box;padding:12px 14px;border-radius:12px;border:1px solid #1f2a44;background:#0b1328;color:#fff;font-size:16px;outline:none;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:8px;border-bottom:1px solid #1f2a44;text-align:left;}
    .hidden{display:none;}
    .timeBar{width:280px;height:12px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);overflow:hidden;}
    .timeBarFill{height:100%;width:100%;border-radius:999px;transition:width .35s linear,background-color .25s ease;}
    .round-pill{display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:999px;border:1px solid #1f2a44;background:rgba(17,26,46,.65);font-weight:900;min-width:54px;}
    .winner-hero{text-align:center;padding:18px 12px;}
    .cup{font-size:76px;line-height:1;display:inline-block;filter:drop-shadow(0 12px 28px rgba(0,0,0,.55));transform:translateY(10px) scale(.9);opacity:0;}
    .winner-title{margin:10px 0 0;font-size:30px;font-weight:800;opacity:0;transform:translateY(8px);}
    .winner-name{margin:6px 0 0;font-size:22px;opacity:0;transform:translateY(8px);}
    .winner-score{margin:8px 0 0;font-size:18px;opacity:0;transform:translateY(8px);}
    #winnerScreen.pop .cup{animation:popIn .7s cubic-bezier(.2,.9,.2,1) forwards;}
    #winnerScreen.pop .winner-title{animation:slideUp .6s .12s cubic-bezier(.2,.9,.2,1) forwards;}
    #winnerScreen.pop .winner-name{animation:slideUp .6s .22s cubic-bezier(.2,.9,.2,1) forwards;}
    #winnerScreen.pop .winner-score{animation:slideUp .6s .32s cubic-bezier(.2,.9,.2,1) forwards;}
    .podium{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .podium .p{flex:1;min-width:220px;border:1px solid #1f2a44;border-radius:12px;padding:12px;}
    .big{font-size:22px;font-weight:700;}
    #winnerScreen.pop .podium .p{animation:rise .5s .25s ease-out both;}
    #winnerScreen.pop .podium .p:nth-child(2){animation-delay:.33s;}
    #winnerScreen.pop .podium .p:nth-child(3){animation-delay:.41s;}
    @keyframes popIn{to{opacity:1;transform:translateY(0) scale(1);}}
    @keyframes slideUp{to{opacity:1;transform:translateY(0);}}
    @keyframes rise{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    #confetti{position:fixed;inset:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;display:none;}
    #volumeBox{position:fixed;top:16px;right:20px;display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(17,26,46,.95);border-radius:14px;border:1px solid #1f2a44;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    #volumeBox .vol-icon{width:22px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;}
    #volumeBox input[type="range"]{width:180px;height:6px;cursor:pointer;}
    #volumeBox #volLabel{min-width:52px;text-align:right;font-weight:700;font-size:16px;opacity:.95;}
    #volumeBox button.mute-btn{width:56px;height:40px;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;font-size:18px;line-height:1;border:1px solid #1f2a44;cursor:pointer;user-select:none;transition:transform .15s ease,filter .15s ease,box-shadow .15s ease;background:#475569;color:#fff;}
    #volumeBox button.mute-btn.is-on{background:linear-gradient(135deg,#8b5cf6,#6d28d9);box-shadow:0 10px 22px rgba(139,92,246,.35);}
    #volumeBox button.mute-btn.is-off{background:#475569;box-shadow:none;}
    .copyLink{cursor:pointer;user-select:none;font-size:18px;opacity:.9}
    .copyLink:hover{opacity:1;transform:scale(1.08)}
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>

  <div id="volumeBox">
    <span class="vol-icon" id="volIcon">üîä</span>
    <input id="vol" type="range" min="0" max="100" value="80">
    <span id="volLabel">80%</span>
    <button id="muteBtn" class="mute-btn is-on" type="button" aria-label="Mute">üîä</button>
  </div>

  <div class="wrap">
    <div class="titleRow"><h1 id="playerTitle">–ò–≥—Ä–æ–∫</h1></div>

    <div class="card" id="joinCard">
      <div class="muted" id="joinHint" style="margin-bottom:10px;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∏–≥—Ä—É</div>
      <input id="name" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="24" />

      <div class="row" style="margin-top:10px;">
        <button id="joinBtn">–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
        <span class="badge" id="roomBadge">–ö–æ–º–Ω–∞—Ç–∞: ‚Äî</span>
        <span class="badge" id="statusBadge">–ù–µ –≤ –∏–≥—Ä–µ</span>
      </div>

      <div class="row" id="autoRoomRow" style="margin-top:10px;display:none;">
        <span class="badge" id="autoRoomCode">–ö–æ–º–Ω–∞—Ç–∞: ‚Äî</span>
        <span class="badge" id="autoRoomLink">–°—Å—ã–ª–∫–∞: ‚Äî</span>
        <span class="copyLink" id="copyBtn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">üìã</span>
      </div>

      <div class="muted" id="autoWaitHint" style="margin-top:10px;display:none;">‚Äî</div>
    </div>

    <div id="gameScreen" class="hidden">
      <div class="card">
        <div class="row">
          <span class="badge" id="qBadge">–í–æ–ø—Ä–æ—Å: ‚Äî</span>
          <!-- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –±–µ–π–¥–∂ –∫–æ–º–Ω–∞—Ç—ã –≤ –∏–≥—Ä–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ mode=auto2) -->
          <span class="badge hidden" id="roomBadgeInGame">–ö–æ–º–Ω–∞—Ç–∞: ‚Äî</span>
          <div class="timeBar"><div id="timeBarFill" class="timeBarFill"></div></div>
          <span id="roundPill" class="round-pill">‚Äî</span>
        </div>
        <h2 style="margin-top:10px;">–í–æ–ø—Ä–æ—Å</h2>
        <div id="questionText">‚Äî</div>
      </div>

      <div class="card">
        <h2>–í–∞—à –æ—Ç–≤–µ—Ç</h2>
        <input id="answer" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–ø—Ä–∞–≤–∏—Ç—å" maxlength="60" />
        <div class="row" style="margin-top:10px;">
          <button id="sendBtn" class="violet">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button id="clearBtn" class="secondary" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <span class="muted" id="sendHint">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h2>–¢–∞–±–ª–∏—Ü–∞</h2>
        <table><thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–û—á–∫–∏</th></tr></thead><tbody id="players"></tbody></table>
      </div>
    </div>

    <div id="winnerScreen" class="hidden">
      <div class="card">
        <div class="winner-hero">
          <div class="cup">üèÜ</div>
          <div class="winner-title">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
          <div class="winner-name" id="winnerName">‚Äî</div>
          <div class="winner-score" id="winnerScore">–û—á–∫–∏: 0</div>
        </div>

        <div class="podium" id="podium"></div>

        <div class="muted" style="margin-top:10px;">
          –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑ ‚Äî –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º.
        </div>
      </div>

      <div class="card">
        <h2>–ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
        <table><thead><tr><th>–ú–µ—Å—Ç–æ</th><th>–ò–º—è</th><th>–û—á–∫–∏</th></tr></thead><tbody id="finalTable"></tbody></table>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const joinCard = document.getElementById("joinCard");
    const joinBtn = document.getElementById("joinBtn");
    const nameEl = document.getElementById("name");
    const roomBadge = document.getElementById("roomBadge");
    const statusBadge = document.getElementById("statusBadge");
    const playerTitle = document.getElementById("playerTitle");
    const joinHint = document.getElementById("joinHint");

    const autoRoomRow = document.getElementById("autoRoomRow");
    const autoRoomCode = document.getElementById("autoRoomCode");
    const autoRoomLink = document.getElementById("autoRoomLink");
    const autoWaitHint = document.getElementById("autoWaitHint");
    const copyBtn = document.getElementById("copyBtn");

    const gameScreen = document.getElementById("gameScreen");
    const winnerScreen = document.getElementById("winnerScreen");

    const qBadge = document.getElementById("qBadge");
    const questionText = document.getElementById("questionText");

    const answerEl = document.getElementById("answer");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const sendHint = document.getElementById("sendHint");

    const playersEl = document.getElementById("players");

    const timeBarFill = document.getElementById("timeBarFill");
    const roundPill = document.getElementById("roundPill");

    const podiumEl = document.getElementById("podium");
    const finalTableEl = document.getElementById("finalTable");
    const winnerNameEl = document.getElementById("winnerName");
    const winnerScoreEl = document.getElementById("winnerScore");

    // ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –±–µ–π–¥–∂–∞ –∫–æ–º–Ω–∞—Ç—ã –≤ –∏–≥—Ä–µ
    const roomBadgeInGame = document.getElementById("roomBadgeInGame");

    const params = new URLSearchParams(location.search);

    const mode = (params.get("mode") || "host").toLowerCase(); // host | solo | auto2
    let roomCode = (params.get("code") || "").toUpperCase();

    const timeSetting = Number(params.get("time") || 60);
    const qSetting = Number(params.get("q") || 10);

    function clampInt(v, min, max, def){
      const n = Number(v);
      if (!Number.isFinite(n)) return def;
      return Math.max(min, Math.min(max, Math.floor(n)));
    }
    const chosenTime = clampInt(timeSetting, 10, 300, 60);
    const chosenQ = clampInt(qSetting, 10, 20, 10);

    roomBadge.textContent = roomCode ? `–ö–æ–º–Ω–∞—Ç–∞: ${roomCode}` : "–ö–æ–º–Ω–∞—Ç–∞: ‚Äî";

    let joined = false;
    let answeredThisQuestion = false;
    let finishHandledFor = null;

    const winAudio = new Audio("/sounds/win.mp3");
    const drumAudio = new Audio("/sounds/drum.mp3");
    winAudio.preload = "auto"; drumAudio.preload = "auto";

    let finishSeqToken = 0;
    let finishFallbackTimer = null;
    let drumEndedHandler = null;

    function cancelFinishSequence(){
      finishSeqToken++;
      if (finishFallbackTimer){ clearTimeout(finishFallbackTimer); finishFallbackTimer = null; }
      if (drumEndedHandler){
        drumAudio.removeEventListener("ended", drumEndedHandler);
        drumEndedHandler = null;
      }
    }
    function stopSounds(){
      cancelFinishSequence();
      try { winAudio.pause(); winAudio.currentTime = 0; } catch(e){}
      try { drumAudio.pause(); drumAudio.currentTime = 0; } catch(e){}
    }

    const volEl = document.getElementById("vol");
    const volLabel = document.getElementById("volLabel");
    const muteBtn = document.getElementById("muteBtn");
    const volIcon = document.getElementById("volIcon");
    let muted = false;

    function applyVolume(){
      const v = Number(volEl.value);
      volLabel.textContent = `${v}%`;
      const vol01 = v / 100;
      winAudio.volume = vol01;
      drumAudio.volume = vol01;
      winAudio.muted = muted;
      drumAudio.muted = muted;
      const icon = muted ? "üîá" : "üîä";
      muteBtn.textContent = icon;
      volIcon.textContent = icon;
      muteBtn.classList.toggle("is-on", !muted);
      muteBtn.classList.toggle("is-off", muted);
    }
    applyVolume();
    volEl.addEventListener("input", () => { muted = false; applyVolume(); });
    muteBtn.addEventListener("click", () => { muted = !muted; applyVolume(); });

    document.addEventListener("click", () => {
      drumAudio.play().then(()=>{drumAudio.pause();drumAudio.currentTime=0;}).catch(()=>{});
      winAudio.play().then(()=>{winAudio.pause();winAudio.currentTime=0;}).catch(()=>{});
    }, { once:true });

    const confettiCanvas = document.getElementById("confetti");
    const ctx = confettiCanvas.getContext("2d");
    function resizeConfetti(){
      confettiCanvas.width = window.innerWidth * devicePixelRatio;
      confettiCanvas.height = window.innerHeight * devicePixelRatio;
      confettiCanvas.style.width = window.innerWidth + "px";
      confettiCanvas.style.height = window.innerHeight + "px";
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener("resize", resizeConfetti);

    function startConfetti(durationMs = 3000){
      resizeConfetti();
      confettiCanvas.style.display = "block";
      const W = window.innerWidth, H = window.innerHeight;
      const particles = [];
      const count = 180;
      for (let i=0;i<count;i++){
        particles.push({x:Math.random()*W,y:-20-Math.random()*H*0.3,vx:(Math.random()*2-1)*2.2,vy:3+Math.random()*4.5,size:4+Math.random()*6,rot:Math.random()*Math.PI,vr:(Math.random()*2-1)*0.2,hue:Math.floor(Math.random()*360),life:0});
      }
      const t0 = performance.now();
      function frame(t){
        const dt = (t - t0);
        ctx.clearRect(0,0,W,H);
        for (const p of particles){
          p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          p.vy += 0.02; p.vx *= 0.995; p.life += 1;
          const sway = Math.sin(p.life*0.1) * 0.6;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = `hsl(${p.hue} 90% 60%)`;
          ctx.fillRect(-p.size/2 + sway, -p.size/2, p.size, p.size);
          ctx.restore();
          if (p.y > H + 30){
            p.y = -20; p.x = Math.random()*W;
            p.vy = 3 + Math.random()*4.5;
          }
        }
        if (dt < durationMs) requestAnimationFrame(frame);
        else { confettiCanvas.style.display="none"; ctx.clearRect(0,0,W,H); }
      }
      requestAnimationFrame(frame);
    }

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function updateTimeUI(timeLeft, duration){
      const d = Math.max(1, Number(duration || 60));
      const t = Math.max(0, Number(timeLeft || 0));
      const ratio = clamp01(t / d);
      timeBarFill.style.width = `${Math.round(ratio * 100)}%`;
      if (ratio > 0.66) timeBarFill.style.backgroundColor = "#22c55e";
      else if (ratio > 0.33) timeBarFill.style.backgroundColor = "#f59e0b";
      else timeBarFill.style.backgroundColor = "#ef4444";
      roundPill.textContent = `${t}—Å`;
    }

    function showGame(){
      winnerScreen.classList.add("hidden");
      gameScreen.classList.remove("hidden");
    }
    function showWinner(){
      gameScreen.classList.add("hidden");
      winnerScreen.classList.remove("hidden");
      winnerScreen.classList.remove("pop");
      void winnerScreen.offsetWidth;
      winnerScreen.classList.add("pop");
    }

    function setPlayerTitle(name){
      const safe = (name || "").trim() || "–ò–≥—Ä–æ–∫";
      playerTitle.textContent = `–ò–≥—Ä–æ–∫: ${safe}`;
    }

    function setAnswerEnabled(on){
      answerEl.disabled = !on;
      clearBtn.disabled = !on;
      sendBtn.disabled = !on || answeredThisQuestion;
    }

    clearBtn.onclick = () => { answerEl.value = ""; };

    sendBtn.onclick = () => {
      if (!joined || answeredThisQuestion) return;
      const text = (answerEl.value || "").trim();
      if (!text) return;
      socket.emit("player:answer", { code: roomCode, text });
      answeredThisQuestion = true;
      sendBtn.disabled = true;
      sendHint.textContent = "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ";
    };

    answerEl.addEventListener("keydown", (e) => { if (e.key === "Enter") sendBtn.click(); });

    socket.on("error:msg", (msg) => alert(msg));

    function runFinishSequence(state){
      if (finishHandledFor === roomCode) { showWinner(); return; }
      finishHandledFor = roomCode;
      const token = ++finishSeqToken;
      const afterDrum = () => {
        if (token !== finishSeqToken) return;
        const players = state.players || [];
        const top = players[0];
        winnerNameEl.textContent = top ? `ü•á ${top.name}` : "‚Äî";
        winnerScoreEl.textContent = `–û—á–∫–∏: ${top ? top.score : 0}`;
        const top3 = players.slice(0,3);
        const medals = ["ü•á","ü•à","ü•â"];
        podiumEl.innerHTML = "";
        for (let i=0;i<3;i++){
          const p = top3[i];
          const name = p ? p.name : "‚Äî";
          const score = p ? p.score : 0;
          const div = document.createElement("div");
          div.className = "p";
          div.innerHTML = `<div class="big">${medals[i]} ${i+1} –º–µ—Å—Ç–æ</div><div style="margin-top:6px;">–ò–≥—Ä–æ–∫: <b>${name}</b></div><div style="margin-top:4px;">–û—á–∫–∏: <b>${score}</b></div>`;
          podiumEl.appendChild(div);
        }
        finalTableEl.innerHTML = "";
        players.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${idx+1}</td><td>${p.name}</td><td>${p.score}</td>`;
          finalTableEl.appendChild(tr);
        });
        showWinner();
        try { winAudio.currentTime = 0; winAudio.play().catch(()=>{}); } catch(e){}
        startConfetti(3000);
      };

      drumEndedHandler = () => { drumEndedHandler = null; afterDrum(); };
      drumAudio.addEventListener("ended", drumEndedHandler, { once:true });

      const durMs = Number.isFinite(drumAudio.duration) && drumAudio.duration > 0 ? Math.ceil(drumAudio.duration * 1000) : 1400;
      finishFallbackTimer = setTimeout(() => {
        finishFallbackTimer = null;
        if (drumEndedHandler){
          drumAudio.removeEventListener("ended", drumEndedHandler);
          drumEndedHandler = null;
        }
        afterDrum();
      }, durMs + 200);

      try {
        drumAudio.currentTime = 0;
        const p = drumAudio.play();
        if (p && typeof p.then === "function") {
          p.catch(() => {
            if (finishFallbackTimer) clearTimeout(finishFallbackTimer);
            finishFallbackTimer = null;
            if (drumEndedHandler){
              drumAudio.removeEventListener("ended", drumEndedHandler);
              drumEndedHandler = null;
            }
            afterDrum();
          });
        }
      } catch (e) {
        if (finishFallbackTimer) clearTimeout(finishFallbackTimer);
        finishFallbackTimer = null;
        if (drumEndedHandler){
          drumAudio.removeEventListener("ended", drumEndedHandler);
          drumEndedHandler = null;
        }
        afterDrum();
      }
    }

    function setupJoinUI(){
      if (mode === "solo") {
        joinHint.textContent = `–°–æ–ª–æ-—Ä–µ–∂–∏–º: –∏–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ (–≤—Ä–µ–º—è: ${chosenTime}—Å, –≤–æ–ø—Ä–æ—Å–æ–≤: ${chosenQ}).`;
        roomBadge.textContent = "–†–µ–∂–∏–º: –°–æ–ª–æ";
        statusBadge.textContent = "–ù–µ –≤ –∏–≥—Ä–µ";
      } else if (mode === "auto2") {
        joinHint.textContent = `–†–µ–∂–∏–º 2+: —Å–æ–∑–¥–∞–¥–∏–º –∫–æ–º–Ω–∞—Ç—É –∏ –ø–æ–∫–∞–∂–µ–º –∫–æ–¥/—Å—Å—ã–ª–∫—É. –ò–≥—Ä–∞ —Å—Ç–∞—Ä—Ç—É–µ—Ç –ø—Ä–∏ 2+ –∏–≥—Ä–æ–∫–∞—Ö.`;
        roomBadge.textContent = "–†–µ–∂–∏–º: 2+";
        statusBadge.textContent = "–ù–µ –≤ –∏–≥—Ä–µ";
      } else {
        joinHint.textContent = "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∏–≥—Ä—É";
        roomBadge.textContent = roomCode ? `–ö–æ–º–Ω–∞—Ç–∞: ${roomCode}` : "–ö–æ–º–Ω–∞—Ç–∞: ‚Äî";
      }
    }

    setupJoinUI();

    copyBtn.onclick = async () => {
      const txt = autoRoomLink.dataset.value || "";
      if (!txt) return;
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = "‚úÖ";
        setTimeout(()=>copyBtn.textContent="üìã", 900);
      } catch(e) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: " + txt);
      }
    };

    joinBtn.onclick = () => {
      stopSounds();
      const name = (nameEl.value || "").trim() || "–ò–≥—Ä–æ–∫";
      setPlayerTitle(name);
      joinBtn.disabled = true;
      joinBtn.textContent = "–í—ã –≤ –∏–≥—Ä–µ ‚úÖ";
      statusBadge.textContent = "–í—ã –≤ –∏–≥—Ä–µ ‚úÖ";
      joined = true;
      joinCard.classList.add("hidden");
      showGame();

      // ‚úÖ –µ—Å–ª–∏ —ç—Ç–æ auto2 –∏ –∫–æ–¥ —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å –≤ –∏–≥—Ä–µ
      if (mode === "auto2" && roomCode) {
        roomBadgeInGame.classList.remove("hidden");
        roomBadgeInGame.textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${roomCode}`;
      }

      if (mode === "solo" || mode === "auto2") {
        socket.emit("auto:create", { mode, name, seconds: chosenTime, count: chosenQ });
        return;
      }
      if (!roomCode) {
        alert("–ù–µ—Ç –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∏ –∑–∞–π–¥–∏—Ç–µ –ø–æ –∫–æ–¥—É.");
        return;
      }
      socket.emit("player:join", { code: roomCode, name });
    };

    socket.on("auto:created", ({ code, mode: createdMode }) => {
      roomCode = (code || "").toUpperCase();

      // ‚úÖ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –≤ –∏–≥—Ä–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ (—Ç–æ–ª—å–∫–æ auto2)
      if (mode === "auto2") {
        roomBadgeInGame.classList.remove("hidden");
        roomBadgeInGame.textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${roomCode}`;
      }

      const link = `${location.origin}/player.html?code=${roomCode}&mode=host`;
      autoRoomRow.style.display = "flex";
      autoRoomCode.textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${roomCode}`;
      autoRoomLink.textContent = `–°—Å—ã–ª–∫–∞: ${link}`;
      autoRoomLink.dataset.value = link;

      autoWaitHint.style.display = "block";
      if (createdMode === "auto2") {
        autoWaitHint.textContent = "–ñ–¥—ë–º –µ—â—ë –º–∏–Ω–∏–º—É–º 1 –∏–≥—Ä–æ–∫–∞ (2+). –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É –∫–æ–¥ –∏–ª–∏ —Å—Å—ã–ª–∫—É.";
      } else {
        autoWaitHint.textContent = "–ò–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.";
      }
    });

    socket.on("room:update", (state) => {
      if (!state) return;
      if (state.code && roomCode && state.code !== roomCode) return;

      // ‚úÖ –µ—Å–ª–∏ —ç—Ç–æ auto2 ‚Äî –¥–µ—Ä–∂–∏–º –±–µ–π–¥–∂ –∫–æ–º–Ω–∞—Ç—ã –≤–∏–¥–∏–º—ã–º
      if (mode === "auto2" && roomCode) {
        roomBadgeInGame.classList.remove("hidden");
        roomBadgeInGame.textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${roomCode}`;
      }

      playersEl.innerHTML = "";
      (state.players || []).forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.name}</td><td>${p.score}</td>`;
        playersEl.appendChild(tr);
      });

      const dur = state.questionDuration ?? chosenTime;

      if (state.phase === "lobby") {
        stopSounds();
        finishHandledFor = null;
        showGame();
        qBadge.textContent = "–í–æ–ø—Ä–æ—Å: ‚Äî";

        if (state.mode === "auto2" && state.playerCount < (state.minPlayersToStart || 2)) {
          questionText.textContent = `–ñ–¥—ë–º –∏–≥—Ä–æ–∫–æ–≤... –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${state.minPlayersToStart || 2}. –°–µ–π—á–∞—Å: ${state.playerCount}`;
          sendHint.textContent = "–ñ–¥–∏—Ç–µ, –ø–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–∞—Ç—Å—è –∏–≥—Ä–æ–∫–∏‚Ä¶";
        } else {
          questionText.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞‚Ä¶";
          sendHint.textContent = "–ñ–¥–∏—Ç–µ –Ω–∞—á–∞–ª–∞ –≤–æ–ø—Ä–æ—Å–∞‚Ä¶";
        }

        answeredThisQuestion = false;
        setAnswerEnabled(false);

        updateTimeUI(0, dur);
        roundPill.textContent = `${dur}—Å`;
        return;
      }

      if (state.phase === "question") {
        showGame();
        qBadge.textContent = `–í–æ–ø—Ä–æ—Å ${state.questionNumber}/${state.totalQuestions}`;
        questionText.textContent = state.question || "‚Äî";

        answeredThisQuestion = false;
        sendHint.textContent = "–ü–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–∏–º–∞–π—Ç–µ –û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        setAnswerEnabled(true);

        updateTimeUI(state.timeLeft ?? 0, dur);
        return;
      }

      if (state.phase === "results") {
        showGame();
        qBadge.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (${state.questionNumber}/${state.totalQuestions})`;
        questionText.textContent = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ñ–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å‚Ä¶";

        sendHint.textContent = "–ñ–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å‚Ä¶";
        setAnswerEnabled(false);
        answerEl.value = "";

        updateTimeUI(0, dur);
        roundPill.textContent = `${dur}—Å`;
        return;
      }

      if (state.phase === "finished") {
        setAnswerEnabled(false);
        runFinishSequence(state);
      }
    });

    setAnswerEnabled(false);

    if (mode === "host" && !roomCode) {
      statusBadge.textContent = "–ù–µ—Ç –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã";
      joinBtn.textContent = "–ù—É–∂–µ–Ω –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã";
    }
  </script>
</body>
</html>
