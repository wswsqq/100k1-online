<!-- public/host.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100 –∫ 1 ‚Äî –í–µ–¥—É—â–∏–π</title>
  <style>
    body{
      margin:0;font-family:system-ui,Arial,sans-serif;color:#fff;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(59,130,246,1), transparent 60%),
        radial-gradient(1000px 900px at 90% 35%, rgba(168,85,247,1), transparent 65%),
        radial-gradient(900px 900px at 50% 90%, rgba(217,70,239,0.95), transparent 70%),
        linear-gradient(180deg,#0b102a,#0b102a);
      min-height:100vh;
    }
    .wrap{max-width:900px;margin:0 auto;padding:20px;}
    h1{margin:0 0 14px;text-align:center;}
    .card{
      background:rgba(17,26,46,.92);border-radius:14px;padding:16px;margin-bottom:16px;
      border:1px solid #1f2a44;box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .muted{opacity:.82}
    .badge{display:inline-block;padding:4px 10px;border:1px solid #1f2a44;border-radius:999px;}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1f2a44;text-align:left;}
    .hidden{display:none}

    button{
      padding:10px 14px;border-radius:12px;border:none;color:#fff;font-size:16px;cursor:pointer;
      transition:transform .15s ease,filter .15s ease,box-shadow .15s ease,opacity .15s ease;
      user-select:none;line-height:1;
    }
    button.primary{background:linear-gradient(135deg,#8b5cf6,#6d28d9);box-shadow:0 10px 22px rgba(139,92,246,.28);}
    button.secondary{background:#475569;}
    button.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);box-shadow:0 10px 22px rgba(239,68,68,.22);}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none!important;filter:none!important;box-shadow:none!important;}

    .presetRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .presetBtn{padding:7px 12px;border-radius:999px;font-weight:800;font-size:14px;border:1px solid #1f2a44;}
    .presetBtn.is-active{background:linear-gradient(135deg,#8b5cf6,#6d28d9);box-shadow:0 10px 22px rgba(139,92,246,.22);}
    .presetRow.is-locked{opacity:1;filter:none;}
    .presetRow.is-locked .presetBtn{cursor:not-allowed;}

    .timeBar{width:280px;height:12px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);overflow:hidden;}
    .timeBarFill{height:100%;width:100%;border-radius:999px;transition:width .35s linear,background-color .25s ease;}
    .round-pill{
      display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:999px;
      border:1px solid #1f2a44;background:rgba(17,26,46,.65);font-weight:900;min-width:54px;
    }

    #qInfo{font-size:22px;line-height:1.35;font-weight:700;margin-top:8px;}
    #gameScreen .card:first-of-type{padding:26px 22px;border-radius:18px;}
    #gameScreen .card:first-of-type h2{font-size:30px;margin:0;letter-spacing:.2px;}

    .winner-hero{text-align:center;padding:18px 12px;}
    .cup{font-size:76px;line-height:1;display:inline-block;filter:drop-shadow(0 12px 28px rgba(0,0,0,.55));transform:translateY(10px) scale(.9);opacity:0;}
    .winner-title{margin:10px 0 0;font-size:30px;font-weight:800;opacity:0;transform:translateY(8px);}
    .winner-name{margin:6px 0 0;font-size:22px;opacity:0;transform:translateY(8px);}
    .winner-score{margin:8px 0 0;font-size:18px;opacity:0;transform:translateY(8px);}
    #winnerScreen.pop .cup{animation:popIn .7s cubic-bezier(.2,.9,.2,1) forwards;}
    #winnerScreen.pop .winner-title{animation:slideUp .6s .12s cubic-bezier(.2,.9,.2,1) forwards;}
    #winnerScreen.pop .winner-name{animation:slideUp .6s .22s cubic-bezier(.2,.9,.2,1) forwards;}
    #winnerScreen.pop .winner-score{animation:slideUp .6s .32s cubic-bezier(.2,.9,.2,1) forwards;}
    .podium{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .podium .p{flex:1;min-width:220px;border:1px solid #1f2a44;border-radius:12px;padding:12px;}
    .big{font-size:22px;font-weight:700;}
    #winnerScreen.pop .podium .p{animation:rise .5s .25s ease-out both;}
    #winnerScreen.pop .podium .p:nth-child(2){animation-delay:.33s;}
    #winnerScreen.pop .podium .p:nth-child(3){animation-delay:.41s;}
    @keyframes popIn{to{opacity:1;transform:translateY(0) scale(1);}}
    @keyframes slideUp{to{opacity:1;transform:translateY(0);}}
    @keyframes rise{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

    /* volume stable */
    #volumeBox{
      position:fixed;top:16px;right:20px;display:flex;align-items:center;gap:10px;
      padding:10px 14px;background:rgba(17,26,46,.95);border-radius:14px;border:1px solid #1f2a44;
      z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    #volumeBox .vol-icon{width:22px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;}
    #volumeBox input[type="range"]{width:180px;height:6px;cursor:pointer;}
    #volumeBox #volLabel{min-width:52px;text-align:right;font-weight:700;font-size:16px;opacity:.95;}
    #volumeBox button.mute-btn{
      width:56px;height:40px;padding:0;
      display:inline-flex;align-items:center;justify-content:center;
      border-radius:12px;font-size:18px;line-height:1;border:1px solid #1f2a44;
      cursor:pointer;user-select:none;transition:transform .15s ease,filter .15s ease,box-shadow .15s ease;
    }
    #volumeBox button.mute-btn.is-on{background:linear-gradient(135deg,#8b5cf6,#6d28d9);box-shadow:0 10px 22px rgba(139,92,246,.35);}
    #volumeBox button.mute-btn.is-off{background:#475569;box-shadow:none;}
  </style>
</head>

<body>
  <div id="volumeBox">
    <span class="vol-icon" id="volIcon">üîä</span>
    <input id="vol" type="range" min="0" max="100" value="80">
    <span id="volLabel">80%</span>
    <button id="muteBtn" class="mute-btn is-on" type="button" aria-label="Mute">üîä</button>
  </div>

  <div class="wrap">
    <h1>–í–µ–¥—É—â–∏–π</h1>

    <div class="card">
      <div class="row">
        <button id="createRoom" class="primary">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        <button id="nextBtn" class="primary" disabled>–ù–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å</button>
        <button id="resultsBtn" class="secondary" disabled>–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        <button id="finishBtn" class="danger hidden">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
        <span class="badge" id="countInfo">0/0 –æ—Ç–≤–µ—Ç–∏–ª–∏</span>
      </div>

      <div class="presetRow" id="presetRowTime">
        <span class="muted" style="font-weight:800;">‚è± –í—Ä–µ–º—è:</span>
        <button id="preset30" class="presetBtn secondary" type="button">30—Å</button>
        <button id="preset60" class="presetBtn secondary" type="button">60—Å</button>
        <button id="preset90" class="presetBtn secondary" type="button">90—Å</button>
        <div class="timeBar"><div id="timeBarFill" class="timeBarFill"></div></div>
        <span id="roundPill" class="round-pill">60—Å</span>
      </div>

      <div class="presetRow" id="presetRowCount">
        <span class="muted" style="font-weight:800;">üì¶ –í–æ–ø—Ä–æ—Å–æ–≤:</span>
        <button id="q10" class="presetBtn secondary" type="button">10</button>
        <button id="q15" class="presetBtn secondary" type="button">15</button>
        <button id="q20" class="presetBtn secondary" type="button">20</button>
        <span id="countPill" class="round-pill">10</span>
      </div>

      <div id="roomInfo" class="muted" style="margin-top:10px">‚Äî</div>
    </div>

    <div id="gameScreen">
      <div class="card">
        <h2>–í–æ–ø—Ä–æ—Å</h2>
        <div id="qInfo">‚Äî</div>
      </div>

      <div class="card">
        <h2>–≠—Ç–∞–ª–æ–Ω (5 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)</h2>
        <table><thead><tr><th>–ë–∞–ª–ª—ã</th><th>–û—Ç–≤–µ—Ç</th></tr></thead><tbody id="key"></tbody></table>
        <div class="muted" id="keyHint" style="margin-top:8px">–≠—Ç–∞–ª–æ–Ω –ø–æ—è–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –≤–æ–ø—Ä–æ—Å.</div>
      </div>

      <div class="card">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ–ø—Ä–æ—Å–∞</h2>
        <table><thead><tr><th>–ò–≥—Ä–æ–∫</th><th>–û—Ç–≤–µ—Ç</th><th>–ë–∞–ª–ª—ã</th></tr></thead><tbody id="subs"></tbody></table>
        <div class="muted" id="subsHint" style="margin-top:8px">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã¬ª –∏–ª–∏ –∫–æ–≥–¥–∞ –≤—ã–π–¥–µ—Ç –≤—Ä–µ–º—è.</div>
      </div>

      <div class="card">
        <h2>–û–±—â–∏–π —Å—á—ë—Ç</h2>
        <table><thead><tr><th>–ò–º—è</th><th>–û—á–∫–∏</th></tr></thead><tbody id="players"></tbody></table>
      </div>
    </div>

    <div id="winnerScreen" class="hidden">
      <div class="card">
        <div class="winner-hero">
          <div class="cup">üèÜ</div>
          <div class="winner-title">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
          <div class="winner-name" id="winnerName">‚Äî</div>
          <div class="winner-score" id="winnerScore">–û—á–∫–∏: 0</div>
        </div>

        <div class="podium" id="podium"></div>

        <div class="row" style="margin-top:12px;">
          <button id="newGameBtn" class="primary">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          –ù–æ–≤–∞—è –∏–≥—Ä–∞ —Å–±—Ä–æ—Å–∏—Ç –æ—á–∫–∏ –∏ –≤–µ—Ä–Ω—ë—Ç –∫ –Ω–∞—á–∞–ª—É. –ò–≥—Ä–æ–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã.
        </div>
      </div>

      <div class="card">
        <h2>–ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
        <table><thead><tr><th>–ú–µ—Å—Ç–æ</th><th>–ò–º—è</th><th>–û—á–∫–∏</th></tr></thead><tbody id="finalTable"></tbody></table>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const roomInfo = document.getElementById("roomInfo");
    const qInfo = document.getElementById("qInfo");
    const playersEl = document.getElementById("players");
    const subsEl = document.getElementById("subs");
    const subsHint = document.getElementById("subsHint");
    const nextBtn = document.getElementById("nextBtn");
    const resultsBtn = document.getElementById("resultsBtn");
    const finishBtn = document.getElementById("finishBtn");
    const countInfo = document.getElementById("countInfo");

    const keyEl = document.getElementById("key");
    const keyHint = document.getElementById("keyHint");

    const gameScreen = document.getElementById("gameScreen");
    const winnerScreen = document.getElementById("winnerScreen");
    const podiumEl = document.getElementById("podium");
    const finalTableEl = document.getElementById("finalTable");
    const newGameBtn = document.getElementById("newGameBtn");
    const winnerNameEl = document.getElementById("winnerName");
    const winnerScoreEl = document.getElementById("winnerScore");

    // sounds + volume
    const winAudio = new Audio("/sounds/win.mp3");
    const drumAudio = new Audio("/sounds/drum.mp3");
    winAudio.preload = "auto"; drumAudio.preload = "auto";

    let finishSeqToken = 0;
    let finishFallbackTimer = null;
    let drumEndedHandler = null;

    function cancelFinishSequence(){
      finishSeqToken++;
      if (finishFallbackTimer){ clearTimeout(finishFallbackTimer); finishFallbackTimer = null; }
      if (drumEndedHandler){
        drumAudio.removeEventListener("ended", drumEndedHandler);
        drumEndedHandler = null;
      }
    }

    function stopSounds(){
      cancelFinishSequence();
      try { winAudio.pause(); winAudio.currentTime = 0; } catch(e){}
      try { drumAudio.pause(); drumAudio.currentTime = 0; } catch(e){}
    }

    const volEl = document.getElementById("vol");
    const volLabel = document.getElementById("volLabel");
    const muteBtn = document.getElementById("muteBtn");
    const volIcon = document.getElementById("volIcon");
    let muted = false;

    function applyVolume(){
      const v = Number(volEl.value);
      volLabel.textContent = `${v}%`;
      const vol01 = v / 100;
      winAudio.volume = vol01;
      drumAudio.volume = vol01;
      winAudio.muted = muted;
      drumAudio.muted = muted;
      const icon = muted ? "üîá" : "üîä";
      muteBtn.textContent = icon;
      volIcon.textContent = icon;
      muteBtn.classList.toggle("is-on", !muted);
      muteBtn.classList.toggle("is-off", muted);
    }
    applyVolume();
    volEl.addEventListener("input", () => { muted = false; applyVolume(); });
    muteBtn.addEventListener("click", () => { muted = !muted; applyVolume(); });

    // audio warmup
    document.addEventListener("click", () => {
      drumAudio.play().then(()=>{drumAudio.pause();drumAudio.currentTime=0;}).catch(()=>{});
      winAudio.play().then(()=>{winAudio.pause();winAudio.currentTime=0;}).catch(()=>{});
    }, { once:true });

    // time presets
    const presetRowTime = document.getElementById("presetRowTime");
    const preset30 = document.getElementById("preset30");
    const preset60 = document.getElementById("preset60");
    const preset90 = document.getElementById("preset90");
    const timeBarFill = document.getElementById("timeBarFill");
    const roundPill = document.getElementById("roundPill");

    // count presets
    const presetRowCount = document.getElementById("presetRowCount");
    const q10 = document.getElementById("q10");
    const q15 = document.getElementById("q15");
    const q20 = document.getElementById("q20");
    const countPill = document.getElementById("countPill");

    let roomCode = null;
    let startedOnce = false;
    let fixedSeconds = 60;
    let selectedSeconds = 60;
    let selectedCount = 10;

    let timeLocked = false;
    let countLocked = false;

    let finishHandledFor = null;
    let winPlayedFor = null;

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function updateTimeBar(timeLeft){
      const maxT = Math.max(1, fixedSeconds || 60);
      const ratio = clamp01((timeLeft ?? 0) / maxT);
      timeBarFill.style.width = `${Math.round(ratio * 100)}%`;
      if (ratio > 0.66) timeBarFill.style.backgroundColor = "#22c55e";
      else if (ratio > 0.33) timeBarFill.style.backgroundColor = "#f59e0b";
      else timeBarFill.style.backgroundColor = "#ef4444";
    }

    function setTimePreset(sec){
      selectedSeconds = sec;
      preset30.classList.toggle("is-active", sec === 30);
      preset60.classList.toggle("is-active", sec === 60);
      preset90.classList.toggle("is-active", sec === 90);
      if (!startedOnce) roundPill.textContent = `${sec}—Å`;
      if (roomCode) socket.emit("host:set_time", { code: roomCode, seconds: sec });
    }
    function lockTime(lock){
      timeLocked = lock;
      presetRowTime.classList.toggle("is-locked", lock);
      preset30.disabled = lock; preset60.disabled = lock; preset90.disabled = lock;
    }

    function setCountPreset(c){
      selectedCount = c;
      q10.classList.toggle("is-active", c === 10);
      q15.classList.toggle("is-active", c === 15);
      q20.classList.toggle("is-active", c === 20);
      countPill.textContent = String(c);
      if (roomCode) socket.emit("host:set_qcount", { code: roomCode, count: c });
    }
    function lockCount(lock){
      countLocked = lock;
      presetRowCount.classList.toggle("is-locked", lock);
      q10.disabled = lock; q15.disabled = lock; q20.disabled = lock;
    }

    preset30.onclick = () => { if (!timeLocked) setTimePreset(30); };
    preset60.onclick = () => { if (!timeLocked) setTimePreset(60); };
    preset90.onclick = () => { if (!timeLocked) setTimePreset(90); };

    q10.onclick = () => { if (!countLocked) setCountPreset(10); };
    q15.onclick = () => { if (!countLocked) setCountPreset(15); };
    q20.onclick = () => { if (!countLocked) setCountPreset(20); };

    setTimePreset(60);
    setCountPreset(10);
    lockTime(false);
    lockCount(false);
    fixedSeconds = selectedSeconds;
    updateTimeBar(0);

    // buttons (stop sounds)
    document.getElementById("createRoom").onclick = () => { stopSounds(); socket.emit("host:create"); };
    nextBtn.onclick = () => socket.emit("host:next", { code: roomCode });
    resultsBtn.onclick = () => socket.emit("host:show_results", { code: roomCode });
    finishBtn.onclick = () => socket.emit("host:finish", { code: roomCode });
    newGameBtn.onclick = () => { stopSounds(); socket.emit("host:reset", { code: roomCode }); };

    function showGameScreen(){
      winnerScreen.classList.add("hidden");
      gameScreen.classList.remove("hidden");
    }

    function showWinnerScreen(state){
      gameScreen.classList.add("hidden");
      winnerScreen.classList.remove("hidden");
      winnerScreen.classList.remove("pop");
      void winnerScreen.offsetWidth;
      winnerScreen.classList.add("pop");

      const players = state.players || [];
      const top = players[0];
      winnerNameEl.textContent = top ? `ü•á ${top.name}` : "‚Äî";
      winnerScoreEl.textContent = `–û—á–∫–∏: ${top ? top.score : 0}`;

      const top3 = players.slice(0,3);
      const medals = ["ü•á","ü•à","ü•â"];
      podiumEl.innerHTML = "";
      for (let i=0;i<3;i++){
        const p = top3[i];
        const name = p ? p.name : "‚Äî";
        const score = p ? p.score : 0;
        const div = document.createElement("div");
        div.className = "p";
        div.innerHTML = `<div class="big">${medals[i]} ${i+1} –º–µ—Å—Ç–æ</div>
                         <div style="margin-top:6px;">–ò–≥—Ä–æ–∫: <b>${name}</b></div>
                         <div style="margin-top:4px;">–û—á–∫–∏: <b>${score}</b></div>`;
        podiumEl.appendChild(div);
      }

      finalTableEl.innerHTML = "";
      players.forEach((p, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${idx+1}</td><td>${p.name}</td><td>${p.score}</td>`;
        finalTableEl.appendChild(tr);
      });

      nextBtn.disabled = true;
      resultsBtn.disabled = true;
      finishBtn.classList.add("hidden");
      finishBtn.disabled = true;

      updateTimeBar(0);
      roundPill.textContent = `${fixedSeconds}—Å`;
    }

    function runFinishSequence(state){
      if (finishHandledFor === roomCode) { showWinnerScreen(state); return; }
      finishHandledFor = roomCode;

      const token = ++finishSeqToken;

      const afterDrum = () => {
        if (token !== finishSeqToken) return;
        showWinnerScreen(state);

        if (winPlayedFor !== roomCode) {
          winPlayedFor = roomCode;
          try { winAudio.currentTime = 0; winAudio.play().catch(()=>{}); } catch(e){}
        }
      };

      drumEndedHandler = () => {
        drumEndedHandler = null;
        afterDrum();
      };
      drumAudio.addEventListener("ended", drumEndedHandler, { once:true });

      const durMs =
        Number.isFinite(drumAudio.duration) && drumAudio.duration > 0
          ? Math.ceil(drumAudio.duration * 1000)
          : 1400;

      finishFallbackTimer = setTimeout(() => {
        finishFallbackTimer = null;
        if (drumEndedHandler){
          drumAudio.removeEventListener("ended", drumEndedHandler);
          drumEndedHandler = null;
        }
        afterDrum();
      }, durMs + 200);

      try {
        drumAudio.currentTime = 0;
        const p = drumAudio.play();
        if (p && typeof p.then === "function") {
          p.catch(() => {
            if (finishFallbackTimer) clearTimeout(finishFallbackTimer);
            finishFallbackTimer = null;
            if (drumEndedHandler){
              drumAudio.removeEventListener("ended", drumEndedHandler);
              drumEndedHandler = null;
            }
            afterDrum();
          });
        }
      } catch (e) {
        if (finishFallbackTimer) clearTimeout(finishFallbackTimer);
        finishFallbackTimer = null;
        if (drumEndedHandler){
          drumAudio.removeEventListener("ended", drumEndedHandler);
          drumEndedHandler = null;
        }
        afterDrum();
      }
    }

    socket.on("host:created", ({ code }) => {
      stopSounds();

      roomCode = code;
      const link = `${location.origin}/player.html?code=${code}`;
      roomInfo.innerHTML = `<div>–ö–æ–º–Ω–∞—Ç–∞: <b>${code}</b></div><div style="margin-top:6px;">–°—Å—ã–ª–∫–∞ –∏–≥—Ä–æ–∫–∞–º: <span style="word-break:break-all;">${link}</span></div>`;

      startedOnce = false;
      finishHandledFor = null;
      winPlayedFor = null;

      lockTime(false);
      lockCount(false);

      fixedSeconds = selectedSeconds;
      roundPill.textContent = `${selectedSeconds}—Å`;
      updateTimeBar(0);

      nextBtn.disabled = false;
      nextBtn.textContent = "–ù–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å";
      resultsBtn.disabled = true;

      finishBtn.classList.add("hidden");
      finishBtn.disabled = true;

      socket.emit("host:set_time", { code: roomCode, seconds: selectedSeconds });
      socket.emit("host:set_qcount", { code: roomCode, count: selectedCount });

      showGameScreen();
      qInfo.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞‚Ä¶";
    });

    socket.on("room:update", (state) => {
      if (!state) return;
      if (roomCode && state.code && state.code !== roomCode) return; // ‚úÖ ignore —á—É–∂–∏–µ –∫–æ–º–Ω–∞—Ç—ã

      countInfo.textContent = `${state.answeredCount}/${state.playerCount} –æ—Ç–≤–µ—Ç–∏–ª–∏`;

      playersEl.innerHTML = "";
      (state.players || []).forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.name}</td><td>${p.score}</td>`;
        playersEl.appendChild(tr);
      });

      const left = Number(state.timeLeft ?? 0);

      if (state.phase === "question") {
        if (!startedOnce) {
          startedOnce = true;
          fixedSeconds = selectedSeconds;
          lockTime(true);
          lockCount(true);
        }
        updateTimeBar(left);
        roundPill.textContent = `${left}—Å`;
      } else {
        updateTimeBar(0);
        roundPill.textContent = `${fixedSeconds}—Å`;
      }

      if (state.phase === "finished") {
        runFinishSequence(state);
        return;
      } else {
        showGameScreen();
      }

      if (state.phase === "lobby") {
        stopSounds();
        finishHandledFor = null;
        winPlayedFor = null;

        nextBtn.disabled = !roomCode;
        nextBtn.textContent = "–ù–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å";
        resultsBtn.disabled = true;

        finishBtn.classList.add("hidden");
        finishBtn.disabled = true;

        qInfo.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞‚Ä¶";
        subsEl.innerHTML = "";
        subsHint.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.";
        return;
      }

      qInfo.textContent = `–í–æ–ø—Ä–æ—Å ${state.questionNumber}/${state.totalQuestions}: ${state.question}`;

      if (state.phase === "question") {
        nextBtn.disabled = true;
        resultsBtn.disabled = false;

        finishBtn.classList.add("hidden");
        finishBtn.disabled = true;

        subsEl.innerHTML = "";
        subsHint.textContent = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã¬ª –∏–ª–∏ –∫–æ–≥–¥–∞ –≤—ã–π–¥–µ—Ç –≤—Ä–µ–º—è.";
        return;
      }

      if (state.phase === "results") {
        resultsBtn.disabled = true;

        const isLast = state.questionNumber >= state.totalQuestions && state.totalQuestions > 0;
        if (isLast) {
          nextBtn.disabled = true;
          finishBtn.classList.remove("hidden");
          finishBtn.disabled = false;
        } else {
          nextBtn.disabled = false;
          nextBtn.textContent = "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å";
          finishBtn.classList.add("hidden");
          finishBtn.disabled = true;
        }

        subsEl.innerHTML = "";
        subsHint.textContent = "";
        (state.submissions || []).forEach(s => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${s.name}</td><td>${s.text || "‚Äî"}</td><td>${s.points}</td>`;
          subsEl.appendChild(tr);
        });
      }
    });

    socket.on("host:update", (state) => {
      if (!state) return;
      if (roomCode && state.code && state.code !== roomCode) return; // ‚úÖ ignore —á—É–∂–∏–µ –∫–æ–º–Ω–∞—Ç—ã

      keyEl.innerHTML = "";
      if (state.key && state.key.length) {
        keyHint.textContent = "";
        state.key.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${item.points}</td><td>${item.text}</td>`;
          keyEl.appendChild(tr);
        });
      } else {
        keyHint.textContent = "–≠—Ç–∞–ª–æ–Ω –ø–æ—è–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –≤–æ–ø—Ä–æ—Å.";
      }
    });
  </script>
</body>
</html>
